var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};
var InPageContentEdit=function(a){this.m_parent=a;this.m_action=a.dataset.action;this.m_pageId=a.dataset.pageId;this.m_text=JSON.parse(a.dataset.text);this.m_contentId=a.dataset.contentId;this.m_rawContent=a.dataset.rawContent;this.m_editableArea=a.querySelector(".in-page-content-edit__editable-area");this.m_editableAreaStyle=window.getComputedStyle(this.m_editableArea,null);this.m_editableAreaDisplay=this.m_editableAreaStyle.getPropertyValue("display");this.m_editor=a.querySelector(".in-page-content-edit__editor");
this.m_editor.value=this.m_rawContent;this.m_editor.style.display="none";this.m_editor.style.resize="none";this.m_editor.style.overflow="hidden";this.m_editor.style.width="100%";this.m_editor.style.minHeight=this.m_editableAreaStyle.getPropertyValue("line-height");this.m_editor.style.fontSize=this.m_editableAreaStyle.getPropertyValue("font-size");this.m_editor.style.fontFamily=this.m_editableAreaStyle.getPropertyValue("font-family");this.m_editor.style.fontWeight=this.m_editableAreaStyle.getPropertyValue("font-weight");
this.m_editor.style.lineHeight=this.m_editableAreaStyle.getPropertyValue("line-height");this.m_editor.style.color=this.m_editableAreaStyle.getPropertyValue("color");this.m_editor.style.textDecoration=this.m_editableAreaStyle.getPropertyValue("text-decoration");this.m_editor.style.padding=this.m_editableAreaStyle.getPropertyValue("padding");this.m_editor.style.margin=this.m_editableAreaStyle.getPropertyValue("margin");this.m_editor.style.marginBottom="0";this.m_editor.style.border=this.m_editableAreaStyle.getPropertyValue("border");
this.m_editor.style.boxShadow=this.m_editableAreaStyle.getPropertyValue("box-shadow");this.m_editor.style.borderRadius=this.m_editableAreaStyle.getPropertyValue("border-radius");this.m_buttons=a.querySelector(".in-page-content-edit__buttons");this.m_buttons.style.display="none";this.m_buttons.querySelectorAll(".toolbar > *").forEach(function(a){a.style.marginTop="var(--gutter-thin)"});this.m_buttonSave=this.m_buttons.querySelector('[data-action="save"]');this.m_buttonPreview=this.m_buttons.querySelector('[data-action="preview"]');
this.m_buttonCancel=this.m_buttons.querySelector('[data-action="cancel"]');this.m_modified=!1;this.addListeners();this.checkIfEmpty()};
InPageContentEdit.prototype.addListeners=function(){var a=this;this.m_parent.addEventListener("click",function(){},!1);this.m_editableArea.addEventListener("click",function(){a.activateEditMode()},!1);if(window.Element&&Element.prototype.closest){this.m_editor.addEventListener("change",function(){a.resizeEditor()},!1);this.m_editor.addEventListener("keydown",function(){a.setModified(!0)},!1);for(var b=$jscomp.makeIterator(["cut","paste","drop","keydown","resizerequest"]),c=b.next();!c.done;c=b.next())this.m_editor.addEventListener(c.value,
function(){a.resizeEditorDelayed()},!1);this.m_buttonSave.addEventListener("click",function(b){a.saveEdition(b)},!1);this.m_buttonPreview.addEventListener("click",function(){a.previewEdition()},!1);this.m_buttonCancel.addEventListener("click",function(b){a.cancelEdition(b)},!1)}};InPageContentEdit.prototype.resizeEditor=function(){var a=window.scrollX,b=window.scrollY;this.m_editor.style.height="auto";this.m_editor.style.height=this.m_editor.scrollHeight+"px";window.scrollTo(a,b)};
InPageContentEdit.prototype.resizeEditorDelayed=function(){var a=this;setTimeout(function(){a.resizeEditor()},7)};InPageContentEdit.prototype.setModified=function(a){(this.m_modified=a)?this.m_parent.classList.add("modified"):this.m_parent.classList.remove("modified")};InPageContentEdit.prototype.checkIfEmpty=function(){this.m_editor.value.match(/^\s*$/)&&(this.m_editableArea.textContent=this.m_text.placeholder)};
InPageContentEdit.prototype.activateEditMode=function(){this.m_editableArea.style.display="none";this.m_editor.style.display=this.m_editableAreaDisplay;this.m_editor.focus();this.m_editor.setSelectionRange(this.m_editor.value.length,this.m_editor.value.length);this.m_buttons.style.display="block";this.resizeEditorDelayed()};InPageContentEdit.prototype.deactivateEditMode=function(){this.m_editableArea.style.display=null;this.m_editor.style.display="none";this.m_buttons.style.display="none"};
InPageContentEdit.prototype.lockEditor=function(a){this.m_editor.disabled=a;this.m_buttonSave.disabled=a;this.m_buttonPreview.disabled=a;this.m_buttonCancel.disabled=a};InPageContentEdit.prototype.xhrSuccess=function(a,b,c){b=void 0===b?null:b;c=void 0===c?null:c;try{a=JSON.parse(a);if("ERROR"===a.status)throw 0;this.m_editableArea.innerHTML=a.content;null!==b&&b();this.deactivateEditMode();this.lockEditor(!1)}catch(e){this.xhrError(c)}this.checkIfEmpty()};
InPageContentEdit.prototype.xhrError=function(a){a=void 0===a?null:a;null!==a&&a();this.lockEditor(!1)};InPageContentEdit.prototype.xhrPost=function(a,b,c){var e=this;b=void 0===b?null:b;c=void 0===c?null:c;var d=new FormData;d.append("content-id",this.m_contentId);d.append("page-id",this.m_pageId);d.append("action",a);d.append("content",this.m_editor.value);SimpleRequest.post(this.m_action,d,function(a){e.xhrSuccess(a,b,c)},function(){e.xhrError(c)})};
InPageContentEdit.prototype.previewEdition=function(){var a=this;this.lockEditor(!0);this.m_buttonPreview.classList.add("loading");this.xhrPost("get-formatted-content",function(){a.m_buttonPreview.classList.remove("loading");a.m_buttonPreview.classList.add("loaded");setTimeout(function(){a.m_buttonPreview.classList.remove("loaded")},1500)},function(){a.m_buttonPreview.classList.remove("loading");a.m_buttonPreview.classList.add("failed");setTimeout(function(){a.m_buttonPreview.classList.remove("failed")},
1500)})};
InPageContentEdit.prototype.saveEdition=function(a){var b=this;this.m_modified&&!confirm(this.m_text.save_confirm.replace("\\n","\n"))?a.preventDefault():(this.m_rawContent=this.m_editor.value,this.lockEditor(!0),this.m_buttonSave.classList.add("loading"),this.xhrPost("save-content",function(){b.setModified(!1);b.m_buttonSave.classList.remove("loading");b.m_buttonSave.classList.add("loaded");setTimeout(function(){b.m_buttonSave.classList.remove("loaded")},1500)},function(){b.m_buttonSave.classList.remove("loading");b.m_buttonSave.classList.add("failed");
setTimeout(function(){b.m_buttonSave.classList.remove("failed")},1500)}))};InPageContentEdit.prototype.cancelEdition=function(a){this.m_modified&&!confirm(this.m_text.cancel_confirm.replace("\\n","\n"))?a.preventDefault():(this.m_editor.value=this.m_rawContent,this.setModified(!1),this.checkIfEmpty(),this.deactivateEditMode())};
